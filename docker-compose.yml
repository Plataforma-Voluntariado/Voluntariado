version: "3.8"

services:
  redis:
    image: redis:latest
    container_name: voluntariado-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - voluntariado-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis-data:/data

  nest-app:
    build:
      context: ./backend/nest-app
      dockerfile: Dockerfile
    image: nest-app:latest
    container_name: voluntariado-nest
    restart: unless-stopped
    ports:
      - "5560:5560"
    env_file:
      - .env
    depends_on:
      redis:
        condition: service_healthy
      api-verificador:
        condition: service_started
      api-sentimiento:
        condition: service_started
      api-certificados:
        condition: service_started
    networks:
      - voluntariado-network
    volumes:
      - ./backend/nest-app/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5560', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  api-verificador:
    build:
      context: ./backend/fastapi-verificador
      dockerfile: Dockerfile
    image: api-verificador:latest
    container_name: voluntariado-verificador
    restart: unless-stopped
    expose:
      - "8001"
    env_file:
      - .env
    networks:
      - voluntariado-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/').getcode()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  api-sentimiento:
    build:
      context: ./backend/api-sentimiento
      dockerfile: Dockerfile
    image: api-sentimiento:latest
    container_name: voluntariado-sentimiento
    restart: unless-stopped
    expose:
      - "8077"
    env_file:
      - .env
    networks:
      - voluntariado-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8077').getcode()"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  api-certificados:
    build:
      context: ./backend/fastapi-certificados
      dockerfile: Dockerfile
    image: api-certificados:latest
    container_name: voluntariado-certificados
    restart: unless-stopped
    expose:
      - "8002"
    env_file:
      - .env
    networks:
      - voluntariado-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/docs').getcode()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        REACT_APP_URL_SERVER_VOLUNTARIADO: ${REACT_APP_URL_SERVER_VOLUNTARIADO}
        REACT_APP_MAPBOX_TOKEN: ${REACT_APP_MAPBOX_TOKEN}
    image: frontend-voluntariado:latest
    container_name: voluntariado-frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      - nest-app
    networks:
      - voluntariado-network

networks:
  voluntariado-network:
    driver: bridge

volumes:
  redis-data:
    driver: local
